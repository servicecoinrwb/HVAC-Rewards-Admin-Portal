<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Point Network Rewards Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .external-link::after {
        content: ' â†—';
        font-size: 0.8em;
        vertical-align: super;
    }
    #customer-list-body::-webkit-scrollbar, #transaction-log::-webkit-scrollbar {
        width: 6px;
    }
    #customer-list-body::-webkit-scrollbar-track, #transaction-log::-webkit-scrollbar-track {
        background: #374151; /* gray-700 */
    }
    #customer-list-body::-webkit-scrollbar-thumb, #transaction-log::-webkit-scrollbar-thumb {
        background: #6b7280; /* gray-500 */
        border-radius: 3px;
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-10 pb-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Service Point Network</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">Rewards & Administration Portal</p>
      </div>
      <div id="wallet-status">
         <button onclick="connectWallet()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Connect Wallet</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Left Column: System Info -->
      <div class="lg:col-span-1 space-y-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">1. System Configuration</h2>
          <div class="space-y-4 text-sm">
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SPN Token:</span><a id="spn-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Staking Contract:</span><a id="staking-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SRV Token:</span><a id="srv-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SREV Token:</span><a id="srev-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Converter Contract:</span><a id="converter-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Yield Contract:</span><a id="yield-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Reward Token:</span><a id="reward-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">Transaction Log</h2>
           <ul id="transaction-log" class="space-y-2 h-96 overflow-y-auto text-sm">
                <li class="text-gray-500 dark:text-gray-400">No actions performed yet.</li>
            </ul>
        </div>
      </div>

      <!-- Right Column: Actions -->
      <div class="lg:col-span-2 space-y-8">
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">2. Add Customer to Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-1">
              <label for="customerNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Number *</label>
              <input type="text" id="customerNumber" placeholder="e.g. CUST-1001" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
            </div>
            <div class="md:col-span-1">
              <label for="customerWallet" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Wallet Address *</label>
              <input type="text" id="customerWallet" placeholder="0x... (Managed by backend)" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
            </div>
             <button onclick="addCustomer()" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Customer</button>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">3. Admin: Issue SPN (Points)</h2>
          <div class="flex items-center gap-3">
             <input id="issueTarget" type="text" placeholder="Target Address" class="block w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
             <input id="issueAmount" type="number" placeholder="e.g. 500" class="block w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
             <button onclick="issueSPN()" class="bg-green-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-700 transition-colors whitespace-nowrap">Issue SPN</button>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">4. Customer Actions</h2>
           <div class="mb-6">
            <label for="targetCustomer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Customer Wallet Address</label>
            <input type="text" id="targetCustomer" placeholder="Enter wallet address from userbase list" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
          </div>
          <h3 class="font-semibold text-lg">Stake SRV</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Stakes entire SRV balance for target.</p>
          <button onclick="stakeSRV()" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">Stake</button>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">5. Convert SPN to SRV</h2>
             <div class="flex items-center gap-4">
                 <input id="convertAmount" type="number" placeholder="SPN Amount to Convert" class="block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
                 <button onclick="approveConversion()" class="w-auto bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-indigo-700">Approve</button>
                 <button onclick="convertSPN()" class="w-auto bg-yellow-500 text-black font-bold py-3 px-5 rounded-lg hover:bg-yellow-600">Convert</button>
             </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
              <h2 class="text-xl font-bold">6. Customer Userbase</h2>
              <button onclick="refreshAllBalances()" class="text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Refresh All</button>
            </div>
            <div id="customer-list-container" class="h-64 overflow-y-auto pr-2">
                <table class="w-full text-sm text-left">
                    <thead class="sticky top-0 bg-gray-50 dark:bg-gray-700 text-xs text-gray-700 dark:text-gray-400 uppercase">
                        <tr>
                            <th scope="col" class="px-4 py-3">Customer</th>
                            <th scope="col" class="px-4 py-3 text-right">SPN</th>
                            <th scope="col" class="px-4 py-3 text-right">SRV</th>
                            <th scope="col" class="px-4 py-3 text-right">SREV</th>
                            <th scope="col" class="px-4 py-3 text-right">USDC</th>
                            <th scope="col" class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customer-list-body">
                        <tr>
                            <td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">No customers added yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let provider, signer;
    let customers = [];
    let contracts = {};

    const addresses = {
        spn: '0x29950E3186999F490777f00d97279a62b2dD1818',
        staking: '0x691e29E98ECDc5ae948355F30102cD4D637eddB7',
        srv: '0x057ba66c2109Fd4487F0781E0203B71fd77a6341',
        srev: '0x2F745Da2FA453ee76c756fADcc081f59284B2a40',
        converter: '0x524997F5Cf25537a275ad5D0A6A346c733a4fA41',
        yield: '0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE',
        reward: '0xaf88d065e77c8cc2239327c5edb3a432268e5831'
    };

    const abis = {
        erc20: JSON.parse(`[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]`),
        spn: JSON.parse(`[{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SPNMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        srv: JSON.parse(`[{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]`),
        converter: JSON.parse(`[{"inputs":[{"internalType":"uint256","name":"spnAmount","type":"uint256"}],"name":"burnAndConvert","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        staking: JSON.parse('[{"inputs":[{"internalType":"address","name":"_for","type":"address"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"}]'),
        yield: JSON.parse(`[{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_srevToken","type":"address"},{"internalType":"address","name":"_daoOperator","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"viewRewardPoolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]`)
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadCustomersFromStorage();
        for (const [key, addr] of Object.entries(addresses)) {
            const el = document.getElementById(`${key}-address`);
            if (el) {
                el.textContent = `${addr.substring(0, 6)}...${addr.substring(addr.length - 6)}`;
                el.href = `https://arbiscan.io/address/${addr}`;
            }
        }
    });

    // --- Wallet Connection ---
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') return showModal('Error', 'MetaMask is not installed.');
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const address = await signer.getAddress();
            
            contracts.spn = new ethers.Contract(addresses.spn, abis.spn, signer);
            contracts.srv = new ethers.Contract(addresses.srv, abis.srv, signer);
            contracts.srev = new ethers.Contract(addresses.srev, abis.erc20, signer);
            contracts.reward = new ethers.Contract(addresses.reward, abis.erc20, signer);
            contracts.converter = new ethers.Contract(addresses.converter, abis.converter, signer);
            contracts.staking = new ethers.Contract(addresses.staking, abis.staking, signer);
            contracts.yield = new ethers.Contract(addresses.yield, abis.yield, signer);

            const walletStatusDiv = document.getElementById('wallet-status');
            walletStatusDiv.innerHTML = `<div class="text-right"><p class="font-semibold text-green-500">Connected</p><p class="text-xs font-mono">${address.substring(0, 6)}...${address.substring(address.length - 4)}</p></div>`;
            addLogEntry(`Wallet ${address.substring(0,6)}... connected.`);
            fetchSystemStats();
        } catch (err) {
            console.error("Connection failed:", err);
            showModal('Connection Failed', err.message || 'Could not connect to wallet.');
        }
    }

    // --- Data Fetching ---
    async function fetchSystemStats() {
        if (!signer) return;
        try {
            const [yieldBal, spnSupply] = await Promise.all([
                contracts.yield.viewRewardPoolBalance(),
                contracts.spn.totalSupply()
            ]);
            document.getElementById('yield-balance').textContent = `${parseFloat(ethers.formatUnits(yieldBal, 6)).toFixed(2)} USDC`;
            document.getElementById('spn-total-supply').textContent = `${parseFloat(ethers.formatUnits(spnSupply, 18)).toLocaleString()}`;
        } catch (e) {
            console.error("Failed to fetch system stats:", e);
        }
    }
    
    // --- Customer Management & Persistence ---
    function saveCustomersToStorage() {
        localStorage.setItem('spn_customer_userbase', JSON.stringify(customers.map(c => ({id: c.id, wallet: c.wallet}))));
    }

    function loadCustomersFromStorage() {
        const storedCustomers = localStorage.getItem('spn_customer_userbase');
        if (storedCustomers) {
            customers = JSON.parse(storedCustomers);
            renderCustomers(false); 
            if (signer) { 
                refreshAllBalances();
            }
        }
    }

    async function fetchCustomerBalances(walletAddress) {
        if (!provider || Object.keys(contracts).length === 0) return { spn: 0, srv: 0, srev: 0, usdc: 0 };
        const balances = { spn: 'Err', srv: 'Err', srev: 'Err', usdc: 'Err' };
        
        try { balances.spn = parseFloat(ethers.formatUnits(await contracts.spn.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SPN Balance Error:`, e); }
        try { balances.srv = parseFloat(ethers.formatUnits(await contracts.srv.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SRV Balance Error:`, e); }
        try { balances.srev = parseFloat(ethers.formatUnits(await contracts.srev.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SREV Balance Error:`, e); }
        try { balances.usdc = parseFloat(ethers.formatUnits(await contracts.reward.balanceOf(walletAddress), 6)); } catch (e) { console.error(`USDC Balance Error:`, e); }

        return balances;
    }

    async function addCustomer() {
        const customerNumberInput = document.getElementById('customerNumber');
        const customerWalletInput = document.getElementById('customerWallet');
        
        const customerNumber = customerNumberInput.value.trim();
        const customerWallet = customerWalletInput.value.trim();

        if (!customerNumber || !customerWallet) return showModal('Input Error', 'Please provide both a customer number and a wallet address.');
        if (!ethers.isAddress(customerWallet)) return showModal('Input Error', 'Please enter a valid wallet address.');
        if (!signer) return showModal('Error', 'Please connect your wallet first.');

        const balances = await fetchCustomerBalances(customerWallet);
        customers.push({ id: customerNumber, wallet: customerWallet, ...balances });
        
        saveCustomersToStorage();
        renderCustomers();
        addLogEntry(`Added customer ${customerNumber} (${customerWallet.substring(0,6)}...).`);
        
        customerNumberInput.value = '';
        customerWalletInput.value = '';
    }
    
    async function refreshAllBalances() {
        if (customers.length === 0) return showModal('Info', 'No customers to refresh.');
        addLogEntry('Refreshing all customer balances...');
        for (const customer of customers) {
            const balances = await fetchCustomerBalances(customer.wallet);
            Object.assign(customer, balances);
        }
        renderCustomers();
        addLogEntry('All balances updated.');
    }
    
    function deleteCustomer(walletAddress) {
        customers = customers.filter(c => c.wallet.toLowerCase() !== walletAddress.toLowerCase());
        saveCustomersToStorage();
        renderCustomers();
        addLogEntry(`Removed customer ${walletAddress.substring(0,6)}...`);
    }

    function renderCustomers(fetchBalances = true) {
        const customerListBody = document.getElementById('customer-list-body');
        if (customers.length === 0) {
            customerListBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">No customers added yet.</td></tr>`;
            return;
        }
        customerListBody.innerHTML = '';
        customers.forEach(customer => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border-b dark:border-gray-700';
            tr.innerHTML = `
                <td class="px-4 py-3">
                    <p class="font-semibold text-sm text-gray-900 dark:text-gray-100">${customer.id}</p>
                    <a href="https://arbiscan.io/address/${customer.wallet}" target="_blank" class="text-xs font-mono text-blue-400 hover:underline">${customer.wallet}</a>
                </td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.spn === 'number' ? customer.spn.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.srv === 'number' ? customer.srv.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.srev === 'number' ? customer.srev.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">$${typeof customer.usdc === 'number' ? customer.usdc.toFixed(2) : '...'}</td>
                <td class="px-4 py-3 text-right"><button onclick="deleteCustomer('${customer.wallet}')" class="text-red-500 hover:text-red-700 font-bold">X</button></td>
            `;
            customerListBody.appendChild(tr);
        });
    }

    // --- Action Functions ---
    async function issueSPN() {
        const target = document.getElementById('issueTarget').value;
        const amount = document.getElementById('issueAmount').value;
        if (!target || !amount) return showModal('Input Error', 'Please provide a target wallet and an amount to issue.');
        if (!ethers.isAddress(target)) return showModal('Input Error', 'Please enter a valid target wallet address.');
        await handleTransaction(contracts.spn, 'mint', [target, ethers.parseUnits(amount, 18)], `Mint ${amount} SPN`);
    }

    async function convertToSRV() {
        const target = document.getElementById('targetCustomer').value;
        if (!target) return showModal('Input Error', 'Please provide a target wallet address.');
        await handleTransaction(contracts.converter, 'convert', [target], 'Convert SPN to SRV');
    }

    async function stakeSRV() {
        const target = document.getElementById('targetCustomer').value;
        if (!target) return showModal('Input Error', 'Please provide a target wallet address.');
        await handleTransaction(contracts.staking, 'stake', [target], 'Stake SRV');
    }
    
    async function fundYieldContract() {
        const amount = document.getElementById('fundAmount').value;
        if (!amount) return showModal('Input Error', 'Please enter an amount to fund.');
        
        showModal('Processing', `Approving ${amount} Reward Tokens...`);
        try {
            const amountInUnits = ethers.parseUnits(amount, 6); 
            const approveTx = await contracts.reward.approve(addresses.yield, amountInUnits);
            await approveTx.wait();
            addLogEntry('Approval successful. Now funding...');
            await handleTransaction(contracts.yield, 'fund', [amountInUnits], `Fund Yield Contract`);
        } catch(e) {
            console.error("Funding failed", e);
            showModal('Error', `Funding failed: ${e.message}`);
        }
    }
    
    async function handleTransaction(contract, method, args, name, refresh = true) {
        if (!signer) return showModal('Error', 'Please connect your wallet first.');
        showModal('Processing', `Sending "${name}" transaction...`);
        try {
            const tx = await contract[method](...args);
            addLogEntry(`Transaction sent for "${name}": ${tx.hash.substring(0,10)}...`);
            await tx.wait();
            showModal('Success', `"${name}" transaction confirmed!`);
            addLogEntry(`"${name}" transaction confirmed.`);
            if(refresh) refreshAllBalances();
        } catch (e) {
            console.error(`${name} failed:`, e);
            showModal('Error', `${name} failed: ${e.reason || e.message}`);
        }
    }

    // --- Logging ---
    function addLogEntry(message) {
        const logList = document.getElementById('transaction-log');
        if (logList.children.length > 0 && logList.children[0].innerText.startsWith('No actions')) {
            logList.innerHTML = '';
        }
        
        const li = document.createElement('li');
        li.className = 'text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 pb-1';
        
        const timestamp = new Date().toLocaleTimeString();
        li.innerHTML = `<span class="font-mono text-xs mr-2">[${timestamp}]</span> ${message}`;
        
        logList.prepend(li);
        if (logList.children.length > 50) {
            logList.removeChild(logList.lastChild);
        }
    }

    // --- UI Utility: Modal ---
    function showModal(title, message) {
        const existingModal = document.getElementById('alertModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'alertModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center border-2 border-blue-500">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">${title}</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-6 break-words">${message}</p>
                <button onclick="document.getElementById('alertModal').remove()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // --- Expose functions to global scope for HTML onclick handlers ---
    window.connectWallet = connectWallet;
    window.addCustomer = addCustomer;
    window.refreshAllBalances = refreshAllBalances;
    window.deleteCustomer = deleteCustomer;
    window.issueSPN = issueSPN;
    window.convertToSRV = convertToSRV;
    window.stakeSRV = stakeSRV;
    window.fundYieldContract = fundYieldContract;
    window.approveConversion = () => handleApproval(contracts.spn, document.getElementById('convertAmount').value, addresses.converter, 'Approve SPN for Conversion');
    window.convertSPN = () => handleTransaction(contracts.converter, 'burnAndConvert', [ethers.parseUnits(document.getElementById('convertAmount').value, 18)], 'Convert SPN to SRV', false);

  </script>
</body>
</html>
